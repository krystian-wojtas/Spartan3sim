\documentclass[a4paper,12pt]{article}

\usepackage[utf8]{inputenc}
\usepackage[T1]{polski}
\usepackage{helvet}
\usepackage{graphicx}
\usepackage{color}
\usepackage{xcolor}
\usepackage{geometry}
\usepackage{register}
\usepackage{listings}
\usepackage{caption}
\usepackage{makeidx}
\usepackage{longtable}
\usepackage{multirow}
\usepackage{wrapfig}


\geometry{hmargin={2cm, 2cm}, height=10.0in}
\DeclareCaptionFont{white}{\color{white}}
\DeclareCaptionFormat{listing}{\colorbox{gray}{\parbox{\textwidth}{#1#2#3}}}
\captionsetup[lstlisting]{format=listing,labelfont=white,textfont=white}
\lstset{ %
language=Verilog,               % choose the language of the code
basicstyle=\footnotesize,       % the size of the fonts that are used for the code
numbers=left,                   % where to put the line-numbers
numberstyle=\footnotesize,      % the size of the fonts that are used for the line-numbers
stepnumber=1,                   % the step between two line-numbers. If it's 1 each line
                                % will be numbered
numbersep=5pt,                  % how far the line-numbers are from the code
backgroundcolor=\color{white},  % choose the background color. You must add \usepackage{color}
showspaces=false,               % show spaces adding particular underscores
showstringspaces=false,         % underline spaces within strings
showtabs=false,                 % show tabs within strings adding particular underscores
frame=single,	                % adds a frame around the code
tabsize=2,	                % sets default tabsize to 2 spaces
%captionpos=b,                   % sets the caption-position to bottom
breaklines=true,                % sets automatic line breaking
breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
title=\lstname,                 % show the filename of files included with \lstinputlisting;
                                % also try caption instead of title
escapeinside={\%*}{*)},         % if you want to add a comment within your code
morekeywords={*,...}            % if you want to add more keywords to the set
}

\lstloadlanguages{ Verilog }

\makeindex

\begin{document}

% =====  STRONA TYTULOWA PRACY MAGISTERSKIEJKIEJ ====
% ostatnia modyfikacja: 2009/07/01, K. Malarz

\thispagestyle{empty}
%% ------------------------ NAGLOWEK STRONY ---------------------------------
\begin{figure}
\vspace{-13cm}
\hspace{-4cm}
\includegraphics[height=29.3cm]{grafika/agh_nzw_a_pl_1w_wbr_cmyk.pdf}\\
\vspace{-13.9cm}
\end{figure}
\rule{26mm}{0pt}
{\large\textsf{Wydział Fizyki i Informatyki Stosowanej}}\\
\rule{\textwidth}{3pt}\\
\rule[2ex]
{\textwidth}{1pt}\\
\vspace{7ex}
\begin{center}
{\LARGE \bf \textsf{Praca magisterska}}\\
\vspace{13ex}
% --------------------------- IMIE I NAZWISKO -------------------------------
{\bf\Large\textsf{Krystian Wojtas}}\\
\vspace{3ex}
{\sf \small kierunek studiów:} {\bf\small\textsf{informatyka stosowana}}\\
\vspace{1.5ex}
{\sf \small kierunek dyplomowania:} {\bf\small\textsf{metody numeryczne}}\\
\vspace{10ex}
%% ------------------------ TYTUL PRACY --------------------------------------
{\bf \huge \textsf{Oprogramowanie sprzętu laboratoryjnego dedykowanego dla przedmiotu "Projektowanie Systemów Cyfrowych"}}\\
\vspace{6ex}
%% ------------------------ OPIEKUN PRACY ------------------------------------
{\Large Opiekun: \bf \textsf{dr inż. Krzysztof Świentek}}\\
\vspace{28ex}
{\large \bf \textsf{Kraków, czerwiec 2012}}
\end{center}
%% =====  STRONA TYTUŁOWA PRACY MAGISTERSKIEJKIEJ ====

\newpage

%% =====  TYŁ STRONY TYTUŁOWEJ PRACY MAGISTERSKIEJKIEJ ====
{\sf Oświadczam, świadomy(-a) odpowiedzialności karnej za poświadczenie nieprawdy, że niniejszą pracę dyplomową wykonałem(-am) osobiście i samodzielnie i  nie korzystałem(-am) ze źródeł innych niż wymienione w pracy.}

\vspace{14ex}

\begin{center}
\begin{tabular}{lr}
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ &
................................................................. \\
~ & {\sf (czytelny podpis)}\\
\end{tabular}
\end{center}

\newpage
\noindent
Na kolejnych dwóch stronach proszę dołączyć kolejno recenzje pracy popełnione przez Opiekuna oraz Recenzenta (wydrukowane z systemu MISIO i podpisane przez odpowiednio Opiekuna i Recenzenta pracy). Papierową wersję pracy (zawierającą podpisane recenzje) proszę złożyć w dziekanacie celem rejestracji co najmniej na tydzień przed planowaną obroną.

\newpage
\noindent
Na kolejnych dwóch stronach proszę dołączyć kolejno recenzje pracy popełnione przez Opiekuna oraz Recenzenta (wydrukowane z systemu MISIO i podpisane przez odpowiednio Opiekuna i Recenzenta pracy). Papierową wersję pracy (zawierającą podpisane recenzje) proszę złożyć w dziekanacie celem rejestracji co najmniej na tydzień przed planowaną obroną.


\vspace{85mm}
\newpage
\tableofcontents

\newpage
\section{Cel pracy}

\begin{figure}[htb]
   \centering
   \includegraphics{grafika/spartan3an.jpg}
   \caption{Xilnix Spartan-3AN Starter Kit}
\end{figure}

Celem pracy jest oprogramowanie za pomocą języka opisu sprzętu (Verliog) układów używanych podczas zajęć laboratoryjnych z Projektowanie Systemów Cyfrowych. Praca polegałaby na przygotowaniu zestawu syntezowalnych bloków HDL do wszystkich elementów płytki „Xilnix Spartan-3AN Starter Kit” (www.xilinx.com/products/devkits/HW-SPAR3AN-SK-UNI-G.htm). Dodatkowo należy opracować modele behawioralne służące do testowania poprawności kodu (poszczególnych modułów sprzętu) tworzonego przez studentów podczas zajęć. Podsumowaniem całości ma być projekt kompleksowo demonstrujący możliwości wyżej wspomnianego sprzętu.

Utworzone moduły behawioralne muszą (wiernie) odzwierciedlać zachowania układów występujących na płytce.
Znajdą wtedy zastosowanie w uruchamianych symulacjach przebiegów czasowych danej konfiguracji układu programowalnego FPGA. Dzięki nim możliwe będzie stwierdzenie czy dla zsyntetyzowanej konfiguracji stany linii FPGA prowadzące do konkretnego układu płytki przebiegają poprawnie i czy zachodzi pożądana komunikacja poprzez generowanie przez te moduły stosownych komunikatów. W ten sposób studenci będą mogli testować poprawność działania utworzonej przez siebie konfiguracji bez fizycznego dosępu do sprzętu.
%zsyntetysowanej/wysyntetyzowanej


\newpage
\section{Projekty}
Każdy z symulowanych układów jest osobnym symulowalnym jak również syntezowalnym projektem środowiska Xilinx ISE. Projekty objęte są rozproszonym systemem kontroli wersji GIT, każdy jest jego osobnym podmodułem spajanym repozytorium superprojektu.

\subsection{Moduły ogólnego zastosowania}
Moduły ogólnego zastosowania, współdzielone pomiędzy projektami położone są w folderze nazwanym generic.

\subsubsection{Zegar}
Jest to moduł niezbędny do symulacji, wprowadza prostokątną linie zegarową.
\lstinputlisting[label=Zegar,caption=Clock.v]{zrodla/generic/sim/Clock.v}

\subsubsection{Reset}
Moduł na chwilę podnosi linię resetu.
\lstinputlisting[label=Reset,caption=Reset.v]{zrodla/generic/sim/Reset.v}

\subsubsection{Funkcja logarytmiczna}
Funkcja ta jest bardzo pomocna w ustaleniu szerokości deklarowanego rejestru na podstawie górnego zakresu liczb przez niego zapamietywanych. Wartość funkcji obliczana jest na etapie elaboracji.
\lstinputlisting[label=log2,caption=log2.v]{zrodla/generic/log2.v}

\subsubsection{Licznik}
Zastosowanie licznika powtarza się bardzo często. Dlatego wydzilony on został do osobnego ogólnego modułu.
\lstinputlisting[label=licznik,caption=Counter.v]{zrodla/generic/Counter.v}

\subsubsection{Rejestr przesuwny}
Rejestr przesuwny zapisuje daną wejsciową z interfejsu równoległego do swojego wewnętrznego rejestry w momencie, gdy zauważy podiesioną flagę 'set'. Jeśli flagi właczenia 'en' oraz działania 'tick' są ustawione, wtedy moduł rejest przesuwa, wstawiając dostarczony bit 'rx' w puste miejsce. Wyjściowy bit 'tx' zawsze wskazuje na bit z końca rejestru.
\lstinputlisting[label=rejestr,caption=Shiftreg.v]{zrodla/generic/Shiftreg.v}

\subsubsection{Serializacja}
Zadaniem modułu jest serializacja tj. przesłanie danych dostarczonych naraz interfejsem równoległym po kolei bit po bicie w takt zegara lub operacja desarializaj tj. operacja odwrotna. Moduł wykorzystuje zaprezentowany rejestr przesuwny oraz licznik.
\lstinputlisting[label=serial,caption=Serial.v]{zrodla/generic/Serial.v}

\subsubsection{SPI}
Serial Peripheral Interface jest popularnym sprzętowym interfejsem komunikacji. Jest on wyjaśniony w części poświęconej DAC-owi. Wykorzystuje moduł serializacji dodając jedynie funcjonalność lini Chip Select.
\lstinputlisting[label=spi,caption=Spi.v]{zrodla/generic/Spi.v}

\subsubsection{Generator impulsów}
Zadaniem generatorota impulsów jest wytwarzanie impulsów jak najbliższe pożadanemu okresowi.
\lstinputlisting[label=BaudRateGenerator,caption=BaudRateGenerator.v]{zrodla/generic/BaudRateGenerator.v}

\newpage
\section{DAC}
Zadaniem konwertera cyfrowo-analogowego jest przetwarzanie przekazanych mu kolejnych liczb binarnych na ich analogowe odpowiedniki realizowane jako wartość napięcia na jego pinie wyjściowym w zakresie napięcia maksymalnego $V_{ref}$.

Obsługiwany przez przetwornik zakres liczb binarnych jest dokładnością przetwornika. Występujący na płytce układ scalony LTC2624 ma zatopione 4 przetworniki DAC o dokładności 12-bitowej. Wszystkie przetworniki domyślnie mają wartość napięcia maksymalnego $V_{ref} = 3.3V$, jednak dla dwóch z nich wartość tą można indywidualnie ustawić komunikując się z układem wzmacniaczy zawartych w kostce LP3906. Wartości napięć wyjściowych podaje wzór
$$V_{out} = \frac{D[11:0]}{4096}  V_{ref}$$

\subsection{Komunikacja}

\subsubsection{SPI}
Układ LTC2624 zaimplementowaną ma logikę komunikacji w standardzie magistrali Serial Peripheral Interface.

\begin{figure}[htb]
   \centering
   \includegraphics[width=15cm]{grafika/spi.jpg}
   \caption{SPI}
\end{figure}

Na magistrali występuje jeden układ nadrzędny - Master oraz co najmniej jeden Slave.
Master generuje zegar na linii SCK.
Master wysyła dane do Slavów szeregowo linią MOSI, Slavy odsyłają dane linią MISO. Transmisja jest fullduplexowana - przesył w obu kierunkach poszczególnych bitów następuje równocześnie w takt zegara.
Między układami współdzielone są linie zegara oraz danych. Odseparowane natomiast są linie CS poszczególnych slavów - wywołanie niskiego potencjału przez mastera aktywuje danego slava do uczestnictwa w wymianie danych.


\newpage
\subsubsection{Połączenia}

\begin{figure}[htb]
   \centering
   \includegraphics[width=15cm]{grafika/dac.jpg}
   \caption{Schemat polaczen ukladow LTC2624 i FPGA}
\end{figure}

Przed pierwszym użyciem należy układ zresetować chwilowo obniżając stan linii DAC\_CLR.

Na linie SPI\_SCK należy podać zegar o częstotliwości nie przekraczającej 50Mhz. Obniżając stan linii DAC\_CS rozpoczynamy komunikację z układem. Wtedy w takt zegara przesyłamy szeregowo do niego kolejne bity danych linią SPI\_MOSI. LTC2624 ładuje kolejne przesyłane bity do swojego rejestru przesuwnego na narastającym zboczu zegara oraz zwraca swoją poprzednią zawartość linią DAC\_OUT na opadającym zboczu. Natychmiast po wysłaniu kompletu danych należy koniecznie podnieść stan linii DAC\_CS zakańczając transmisję.

\begin{figure}[htb]
   \centering
   \includegraphics[width=15cm]{grafika/dac-waveform.jpg}
   \caption{Wykres stanow linii}
\end{figure}


\newpage
\subsubsection{Protokół komunikacji}

\begin{figure}[htb]
  \centering
	\begin{register}{H}{Przesylana ramka}{a}
	\label{dacprotocol}%
	\regfield{Nieistotne}{8}{24}{10000000}%
	\regfield{Komenda}{4}{20}{1100}%
	\regfield{Adres}{4}{16}{1111}%
	\regfield{Wartosc}{12}{4}{100000000000}%
	\regfield{Nieistotne}{4}{0}{0001}%
	\end{register}
\end{figure}

Dane przesyłane do układu LTC2624 są 32-bitową ramką uwidocznioną powyższym polem bitowym. Bity wysyła się kolejno zaczynając od najstarszego. Transmisja zaczyna się ośmioma nic nie znaczącymi bitami. Po nich wysyłane jest 4-bitowe pole komendy - typowo o wartości $0011$, co oznacza natychmiastowe wystawienie zadanej wartości napięcia. Następnie podawany jest adres konwertera według poniższej tabeli

\begin{figure}[htb]
  \centering
	\begin{tabular}{|c|c|c|c|l|}
	  \multicolumn{1}{r}{19}&\multicolumn{1}{r}{}&\multicolumn{1}{r}{}&\multicolumn{1}{r}{16}&\multicolumn{1}{l}{Adres}\\
		\hline
		0&0&0&0 & DAC A\\
		\hline
		0&0&0&1 & DAC B\\
		\hline
		0&0&1&0 & DAC C\\
		\hline
		0&0&1&1 & DAC D\\
		\hline
		1&1&1&1 & Wszystkie\\
		\hline
	\end{tabular}
\end{figure}

Trzecie pole jest 12-bitową wartością binarną odpowiadającą wystawianemu napięciu. Ramka kończy się 4 nieistotnymi bitami. W przykładzie na wszystkich konwerterach pojawiłaby się połowa z ustawionych zakresów napięć.



\subsection{HDL}
\lstinputlisting[caption=Top.v]{../projects/dac/Top.v}
\lstinputlisting[label=Controller,caption=Controller.v]{../projects/dac/Controller.v}
\lstinputlisting[label=DacSpi,caption=DacSpi.v]{../projects/dac/DacSpi.v}

%\newpage
\subsection{Moduł behawioralny}
Wykonana została wzorcowa konfiguracja FPGA poprawnie ustawiająca DAC-i. Przedstawiona symulacja pokazuje wykres przebiegów czasowych linii prowadzących do układu DAC. Układ taktowany jest zegarem 50Mhz pochodzącym z kwarcu dostępnego na płytce. Przesyłana ramka jest przykładem z poprzedniego rozdziału - połowa zakresów napięć wystawiana na wszystkich dac-ach. Pola z bitami nieistonymi są tak ustawione aby pojedynczymi, skrajnymi pikami pokazywały początek i koniec ramki.

\begin{figure}[htb]
   \centering
   \includegraphics[width=13cm]{grafika/toptest-fastdac-110.png}
\end{figure}


\includegraphics[width=15cm]{grafika/dac-uml.jpg}

\lstinputlisting[label=dac,caption=dacLTC2624behav.v]{zrodla/dacLTC2624-behav.v}


\newpage
\section{Rotor}

Płytka Spartan 3AN jest wyposażona w obrotowy przełącznik o dwóch wyprowadzeniach do FPGA. W stanie jałowym są one przyłączone do wysokiego potencjału. Mechaniczne obracanie pokrętła powoduje zwieranie styków na liniach i uziemienie napięcia. Kierunek obrotu wyznacza która linia wcześniej się zewrze do masy.

\begin{figure}[htb]
   \centering
   \includegraphics[width=13cm]{grafika/dso/rotor-w-prawo-jeden.png}
\end{figure}

Obrót w kierunku zgodnym z ruchem wskazówek zegara. Fioletowa linia wykreśla sygnał 'rota'.

\begin{figure}[htb]
   \centering
   \includegraphics[width=13cm]{grafika/dso/rotor-w-prawo-wiele.png}
\end{figure}

Kilka obrotów następujących po sobie.

\subsection{HDL}
\lstinputlisting[label=Toprotor,caption=Top.v]{../projects/rotor/Top.v}
\lstinputlisting[label=Rotor,caption=Rotor.v]{../projects/rotor/Rotor.v}
\lstinputlisting[label=Controller_rotor,caption=Controller.v]{../projects/rotor/Controller.v}


\newpage
\section{Rs232}

Rs232 jest asynchronicznym, szeregowym standardem komunikacyjnym. Zdefiniowane są osobne linie do wysyłanych i odbieranych danych. Szybkość transmisji ustala się ręcznie w urządzeniach końcowych.

Stanem wysokim określony jest stan bezczynności, Nadawanie danych rozpoczyna się od opuszczenia linii Tx na okres jednego bitu tzw. startowego. Natępnie przesyłane są kolejne bity danych i kończone są wysokim bitem stopu.

\subsection{Synteza}

\subsubsection{HDL}
\lstinputlisting[caption=Top.v]{../projects/rs232/Top.v}
\lstinputlisting[label=Rs232Tx,caption=Rs232Tx.v]{../projects/rs232/Rs232Tx.v}
\lstinputlisting[label=Rs232Rx,caption=Rs232Rx.v]{../projects/rs232/Rs232Rx.v}

\subsection{Symulacja}

Moduł symulacyjny wysyła bajt wzorcowy, po czym oczekuje odesłania go z powrotem.

\includegraphics[width=15cm]{grafika/rs232-waveform.jpg}

\subsubsection{HDL}
\lstinputlisting[caption=Top.v]{../projects/rs232/Rs232-behav.v}

\newpage
\section{VGA}
Standard VGA odpowiada za przesłanie obrazu do wyświetlacza przy ustalonych rozmiarach oraz częstotliwości odświeżania. Obraz przesyłany jest punkt po punkcie zwanych pikselami w porządku od lewej do prawej krawędzi kolumny, zaczynając od górnego do dolnego wiersza.

Po przesłaniu każdego wiersza, następuje chwilowe obniżenie linii synchronizacyjnej HSYNC. Natomiast po przesłaniu całej ramki, chwilowo opuszczana jest linia VSYNC. W punktach tych i ich pewnym otoczeniu należy uzniemić linie kolorów.

Kolor pikseli określa złożenie nasycenia trzech podstawowych barw: czerwonej, zielonej i niebieskiej. Ich stan podawany jest osobnymi liniami analogowo wartościami napięcia z zakresu 0.0V - 0.7V.

Płytka Spartan wykorzystuje po 4 cyfrowe wyjścia FPGA dla każdej barwy łączone w drabinki rezystorowe tworząc proste ADC.

\subsection{Synteza}

\subsubsection{Top}
Moduł najwyższy przyjmuje sygnały zegarowy, resetu oraz dwóch przycisków służacych zmianie koloru wyświetlanego tła. Moduł wyprowadza sygnały synchronizacji ramek i kolumn oraz pożądany kolor podany poprzez trzy czterobitowe rejestry nasycenia czerwieni, błękitu i zieleni.
\begin{lstlisting}[label=Topvga,caption=Top.v]
module Top (
    input        CLK50MHZ,
    input        RST,
    // vga interface
    output [3:0] VGA_R,
    output [3:0] VGA_G,
    output [3:0] VGA_B,
    output       VGA_HSYNC,
    output       VGA_VSYNC,
    // color control
    input        BTN_NEXT,
    input        BTN_PREV,
);
\end{lstlisting}

Sygnały przycisków przewijania należy pozbawić drgań styków.
\begin{lstlisting}[label=Topvga,caption=Top.v,firstnumber=15]
    wire next;
    Debouncer debouncer_next (
        .clk(CLK50MHZ),
        .rst(RST),
        .sig(BTN_NEXT),
        .full(next)
    );

    wire prev;
    Debouncer debouncer_prev (
        .clk(CLK50MHZ),
        .rst(RST),
        .sig(BTN_PREV),
        .full(prev)
    );
\end{lstlisting}

Instancje modułów służących sychronizacji oraz podawaniu kolorów.
\begin{lstlisting}[label=Topvga,caption=Top.v,firstnumber=31]
    wire [10:0] x;
    wire [10:0] y;
    wire displaying;
    Sync Sync_(
        .CLK50MHZ(CLK50MHZ),
        .RST(RST),
        // vga interface
        .VGA_HSYNC(VGA_HSYNC),
        .VGA_VSYNC(VGA_VSYNC),
        .x(x),
        .y(y),
        .displaying(displaying)
    );

    Controller Controller_(
        .CLK50MHZ(CLK50MHZ),
        .RST(RST),
        // vga interface
        .VGA_R(VGA_R),
        .VGA_G(VGA_G),
        .VGA_B(VGA_B),
        // color control
        .next(next),
        .prev(prev),
        .x(x),
        .y(y),
        .displaying(displaying)
    );

endmodule
\end{lstlisting}

\subsubsection{Sync}
Zadaniem modułu synchronizacyjnego jest właściwe wytaktowanie linii zawiadamiających o początku nowej ramki lub nowej kolumny. Są to sygnały cyfrowe utrzymywane w stanie wysokim, w chwilach synchronizacji zostają obniżane. Domyślne parametry dostosowane są do przesyłania obrazu rozmiaru 640x480 pikseli przy częstotliwości odświeżania 60 Hz. Odmierzanie czasu przesyłu kolum  bazuje na podstawowym zegarze występującym na płytce o częstotliwości 50 mHz. Natomiast przesłanie ramki sygnalizowane jest po zliczeniu wysłania odpowiedniej liczby kolumn.

Standard VGA powstał w czasach monitorów kineskopowych. Technologia ta ukierunkowywuje elektromagnesami naładowaną wiązkę o wybranej energii w punkt na ekranie, czym wyzwala fotony światła. Momenty gdy wiązka powraca na początek kolejnej linii lub całej ramki są punktami synchronizacji. Wtedy musi być ona wygaszona obniżając wartość składowych kolorów, a także chwilę przed i po synchronizacjach. Sygnał dispalying określa czy kolory mogą być podawane, sygnały współrzędnych x i y podają bieżącą lokalizuję wiązki.

TODO sprawdzic jak to dziala
\begin{lstlisting}[label=Syncvga,caption=Sync.v]
module Sync
#(
   parameter H_S  = 2*800,
   parameter H_FP = 2*16,
   parameter H_PW = 2*96,
   parameter H_BP = 2*48,
   parameter V_S  = 521,
   parameter V_PW = 2,
   parameter V_FP = 10,
   parameter V_BP = 29
) (
   input         CLK50MHZ,
   input         RST,
   // vga interface
   output        VGA_HSYNC,
   output        VGA_VSYNC,
   // tick for next pixel
   output [10:0] x,
   output [10:0] y,
   output        displaying
);
\end{lstlisting}

Synchronizacja opiera się na dwóch licznikach. Pierwszy zlicza zegar podstawowy 50 mHz, drugi zlicza przepełnienia pierwszego śledząc bieżącą linie w ramce. Połączenia i oraz j są aktualnymi stanami liczników.
\begin{lstlisting}[label=Syncvga,caption=Sync.v,firstnumber=23]
        wire [10:0] i;
        wire        h;
        Counter #(
                .MAX(H_S)
        ) Counter_h (
                .CLKB(CLK50MHZ),
                // counter
                .en(1'b1),
                .rst(RST),
                .sig(1'b1), // count all CLK50MHZ ticks
                .cnt(i),
                .full(h)
        );

        wire [9:0] j;
        Counter #(
                .MAX(V_S)
        ) Counter_v (
                .CLKB(CLK50MHZ),
                // counter
                .en(1'b1),
                .rst(RST),
                .sig(h), // count h sync
                .cnt(j)
        );
\end{lstlisting}

Liczniki w stanach od 0 do długosći trwania pulsu wywołują efekt synchronizacji. Natomiast połączenie dispalying obejmuje również chwile zakazu wyświetlania wokół tych punktów.
\begin{lstlisting}[label=Syncvga,caption=Sync.v,firstnumber=49]
        assign displaying = (
            i >= H_PW + H_BP &&
            i <  H_S  - H_FP &&
            j >= V_PW + V_BP &&
            j <= V_S  - V_FP
        );

        assign VGA_HSYNC = (i >  H_PW);
        assign VGA_VSYNC = (j >= V_PW);

        assign x = i - H_PW - H_BP;
        assign y = j - V_PW - V_BP;

endmodule
\end{lstlisting}

\subsubsection{Controller}

Moduł kontrolera odpowiada za kolory poszczególnych pikseli. Dostaje on informacje czy może podawać kolor oraz obecne położenie wiązki. Jednakże jest on uproszczony i wypełnia cały obszar jednym jedynie kolorem, a więc  położenie wiązki jest mu zupełnie zbędne. Dostępnych jest jedynie 8 kolorów. Kolory przełączane są dwoma przyciskami na następny lub poprzedni.
\begin{lstlisting}[label=Syncvga,caption=Sync.v,firstnumber=49]
module Controller (
    input      CLK50MHZ,
    input      RST,
    // vga interface
    output [3:0] VGA_R,
    output [3:0] VGA_G,
    output [3:0] VGA_B,
    // color control
    input        next,
    input        prev,
    input [10:0] x,
    input [10:0] y,
    input displaying
);
\end{lstlisting}

Kolor bieżący zapisany jest w trzybitowym rejestrze. Zmieniany jest poprzez zewnętrzne przyciski. Przepełnianie licznika zachowuje się jak wybieranie od początku.
\begin{lstlisting}[label=Syncvga,caption=Sync.v,firstnumber=16]
   reg [2:0]      i = 1;
   always @(posedge CLK50MHZ)
      if(RST)
        i <= 1;
      else if(next)
        i <= i + 1;
      else if(prev)
        i <= i - 1;
\end{lstlisting}

Każdy z bitów bieżącego koloru odpowiada jednej ze składowych podstawowych. Wartości pośrednie nie są wykorzystywane.
\begin{lstlisting}[label=Syncvga,caption=Sync.v,firstnumber=25]
    assign VGA_R = (displaying && i[0]) ? 4'hf : 4'h0;
    assign VGA_G = (displaying && i[1]) ? 4'hf : 4'h0;
    assign VGA_B = (displaying && i[2]) ? 4'hf : 4'h0;
\end{lstlisting}

\section{Dodatki}

\subsection{Makefile}

Projekty można zsyntetyzować, przesymulować oraz przesłać na płytke z wykorzystaniem programu GNU make. Skrypt wykorzystuje narzędzia Xilinxa dostępne z linii poleceń. W repozytorium podmodułu generic dostępny jest katalog 'makefile' z szablonami dla wszystkich projektów. Makefile'e projektów wyszczególniają swoje zależne pliki po czym załączają ogólny plik Makefile nazwany 'generic'.

\lstinputlisting[label=Makefile,caption=Makefile]{../projects/generic/makefile/generic}
\lstinputlisting[label=config.ut,caption=config.ut]{../projects/generic/makefile/config.ut}
\lstinputlisting[label=config.xst,caption=config.xst]{../projects/generic/makefile/config.xst}
\lstinputlisting{../projects/generic/makefile/impact_batch.tpl}

\subsubsection{DAC}
\lstinputlisting{../projects/dac/project/Makefile}

\subsubsection{Rotor}
\lstinputlisting{../projects/rotor/project/Makefile}

\subsubsection{Rs232}
\lstinputlisting{../projects/rs232/project/Makefile}

\subsubsection{VGA}
\lstinputlisting{../projects/vga/project/Makefile}


\linespread{1.3}
\selectfont

\end{document}

